---
tags:
  - mesh
  - Paper
---

# Introduction

# Related Work

# Surface Fitting and Merging

## Surface Fitting

[[DongMingYan2012]] 系统总结了二次曲面的通用拟合方法，即对于一个二次曲面 $f(X) = 0$ ，其中 $X = (x,y,z)^T \in R^3$是一个欧式空间上的点，可以定义为 $$f(X) = c^T F$$
其中 $c = [c_0,c_1,...,c_{9}]$ 表示该二次曲面对应的未知向量,$F = [x^2,y^2,z^2,xy,yz,zx,x,t,z,1]$ 是任意该二次曲面上的点$X$构成的，二者都是十维向量。

相比起利用最小二乘法获取参数，本文是在已有的初始分块的基础上进一步分块而不是从某个点开始向外生长，针对含有噪声的模型，$c$会主动趋近与$0$ 向量从而获得更加优秀的能量值，这显然不是我们需要的，因此本文会采用奇异值分解获取最优的$c$.

(这里适度解释一下奇异值分解)

### 特殊曲面处理
并非所有的二次曲面都是满秩的，针对不满秩的曲面，这里我们主要讨论平面和柱面，很容易因为极小的噪声被判定为沿主方向曲率半径极大的二次曲面，影响二次划分，因此需要对特殊曲面进行特殊的拟合和距离判定操作

#### 平面

由于在局部曲率特征处理和曲面类型分块时，已经由超参数定义了平面，并且将非平面的曲率信息绝对值归一化处理。由于在超参数有效情况下拓扑连续的一组平面点必定具备平面的所有信息（1-邻域内存在同一个面），因此平面的判定可以相对严格，单独定义其解析式，并且取其中任意一个点，根据其法向和空间位置拟合出平面

#### 柱面

柱面和抛物面都是具备某个主曲率为0的曲面，由于部分模型的特殊性，当某个柱面的采样点分布不均匀且点数较少时，会对法向偏移带来的噪声极为敏感，因此需要制定单独的拟合策略

由于区域内点的集合是带法向的，从几何上分析，柱面的中轴可以被计算成法向集合的最小二乘解。

由中轴方向即可获得柱面的法向旋转量，此时随机选择与中轴垂直的正交向量即可获得柱面的旋转正交基和旋转后的基底与欧式空间基底的旋转矩阵。

欧式空间内点集和法向集也可根据旋转矩阵获取新基底的坐标，并且舍弃掉椭圆中轴方向上的分量，可以起到拟合目标降维的效果，拟合的目标也从柱面变为椭圆

求解椭圆后可根据旋转变换推导出到原有二次曲面的参数映射

## Surface Merging
对于已经获得基础分块的曲面及其对应的点集，由于物体表面噪声或者二次曲面拓扑薄片的存在，难以避免会出现冗余分块，针对不同patch的合并策略会解决这类问题

### Rank based

由于初始分块每个 patch 都具备点集，并且每个二次曲面都可点集构成的线性方程组有关，一个理想的二次曲面分块在理论上是不满秩的。值得一提的是在某些情况下会有非二次曲面或者两个同类型且cross-field无突然旋转的二次曲面光滑拼接的情况，这样的二次曲面也是不满秩的，这样的曲面的处理办法将会在后续章节处理。因此分块合并的初始依据就是将两个面片的二次曲面系数方程联立后计算新的秩，若新的方程组依然不满秩则可合并两个面片。为了针对大网格加速运算，可以在两个 Patch 中随机选择足够多的点而不是所有点构建方程。

### Distance based
相比起基于秩的合并策略，对于一些噪声敏感的二次曲面会存在噪声导致不满秩方程组变成满秩方程组的情况，比如说柱面，当大多数点都沿中轴分布时，少部分点沿着曲面法向上的噪声会严重影响最后的拟合和合并结果，导致方程满秩，因此在秩合并策略之后还需要基于距离的合并策略

方法为将两个patch上的点依照SVD分解获得一个新的二次曲面，并判断两个patch上的点到新的二次曲面的距离，其中最大距离将作为判断二次曲面是否合并的指标，若大于预先设定的值或者相比起合并前有明显增加，则会拒绝这次合并，否则这次合并会被接受。

### patch 边界点后处理

在初始分块时，为了对不同patch进行划分，我们标记了用于分块的edge，那么edge上的点都是无法判断属于哪个patch的,这样的点叫做patch分块边界点，后处理部分需要给这些点也重新划分label。

合并完成后，用来标识分块的点会被分配给相邻的 patch，由于各个patch之间没有拓扑连接关系，而进行全局的距离判断可能会导致某个用于分块的点被几何上不相干的二次曲面包括进去的情况，因此将利用类似火烧法的方式，每次迭代所有边界点，若其与patch内的点相邻，则判断它到相邻patch的距离，若它与多个patch相邻，则被分配到距离最小的patch，重复该迭代直到所有的patch分块边界点都被分配了patch


# 误差驱动的曲面自由生长算法

对于一些同类型高连续性且主曲率对齐的二次曲面拼接复合体，或者一些噪声特别多乃至肉眼无法获得理想的二次曲面划分的patch，本文提出一种生长算法，能够保证无论多么离谱的网格都可以获得一个误差范围内的二次曲面划分

首先判断每个patch上点到拟合好的二次曲面的距离，若大于某个阈值将会把这个点从patch上弹出成一个新的未拟合的二次曲面，弹出后这个patch上的二次曲面将会根据剩下的点进行更新，当该patch弹出的点数大于一定比例时，整个patch将会被弹出到一个新的未拟合的二次曲面。

对于弹出的整个块，首先根据连通性细分成若干个小块，对于每个小块，去除点数过少无法被拟合的块（默认为数量少于达到满秩所需要的10个点则被去除），被去除的块上的点被判定为patch分块边界点，对于剩下的未拟合的块，从边缘上的某一点开始进行广度优先遍历，生成新的块，新的块当点数小于10时，则继续生长，点数大于10时，则判断点到新拟合的曲面的距离是否小于理想阈值，小于的点才能被添加进来，当没有点可以被添加时，这个块生长完毕，形成新的二次曲面patch，对于剩下的点则继续这一步操作，直到所有的点都有一个误差低于给定值的二次曲面分类。

# result
我们在一些经典的三角网格CAD模型和ABC数据集里随机选取样条模型，构建的点云作为测试数据，并且根据样条模型的面片分块作为Ground Truth，构建对比实验。采用的对比对象包括经典的Variational mesh segmentation \cite{YAN20121072},和 RANSAC \cite{schnabel2007efficient} 以及基于神经无符号距离场的 NeurCADRecon \cite{NCAD},Split-and-Fit \cite{saf},Bézier decomposition \cite{bd},SED-Net \cite{sednet}，HP-Net \cite{tang2024hpnetdynamictrajectoryforecasting} 由于不同模型的输入包括点云和网格，输出也包括点云的分类以及二次曲面或者样条面的分块等，本文的方法会针对不同的输入和输出采取不同的策略，为公平起见只在支持同类型输入和输出的模块之间做比较，并根据输入和输出类型采取不同的指标。
## 网格输入，B-rep输出
单以三角网格而言，由于信息相对精确，绝大多数模型都可以获得接近 GT 的划分，我们首先随机测试了ABC数据集上的80个CAD模型，并且禁用了本文的误差驱动曲面自由生长算法来避免误差被异化，部分表示在图片\ref{fig:result}里，从召回率来看所有仅由二次曲面构成的CAD模型网格点的分块平均召回率达到了99.7234%，在准确性上显著具备实际工业应用的价值。

## 点云输入
在点云输入情况下，我们的方法需要首先重建出质量相对较差的三角网格，同时也更好的和同类型基于点云的分块工作做对比，我们引用了相对经典但在水密性和流形性保证上较为鲁棒的marching cube 算法 \cite{mc87} \cite{dyken2008high},构建带噪并丢失尖锐特征的三角网格，并采用不同于特征显著的尖锐三角网格的参数，针对重建网格曲面执行我们的分块算法并获取分块结果的不同指标。本文将针对以下指标评判点云重建效果

- 几何误差：主要用来评判拟合的贴体性，PSD（Point-to-Surface Distance）表示点到所属二次曲面或者样条曲面的距离，用来描述贴体性,不同模型计算得出的这一指标会与模型包围盒斜轴作归一化后作平均，避免过大或过小的模型影响整体测试效果,同样的，为了避免分块过细带来的贴体形提升，我们的方法中的曲面自由生长模块也被禁用。
- 回归误差：这一指标仅仅用于评价分块算法而不涉及拟合，这里使用 F1-score 表示，对于分块和GT，首先根据最大相似点匹配好一对一或者一对多的分块，分别计算属于这个分块的点被计算到别的分块的比例和不属于这个分块的点被计算到这个分块的点的比例，每个分块的指标根据块内点数做加权平均，获得平均的F1-score。

对于 NeurCADRecon \cite{NCAD}和Split-and-Fit \cite{saf}，计算本身会优化点云的位置，因此PSD还是在初始点云上计算，而CAD曲面片并非为二次曲面，分块后的回归误差没有参考价值，因此不做考虑，对于SED-Net \cite{sednet}和HP-Net \cite{tang2024hpnetdynamictrajectoryforecasting} ，只给出了点云的分类结果，而曲面的拟合将会基于分块并将结果用于判断几何误差，而RANSAC \cite{schnabel2007efficient}的输出不仅包括分类也包括了拟合曲面，几何误差将会在其输出的拟合曲面上判断，由于面片是随机采点获得，面片数量不够稳定，因此不考虑其回归误差,统计结果如表格所示，其他模型的数据均来自其原始文章。





## 压力测试

### 带噪点云
带噪点云构建无噪声CAD模型
点云使用Marching Cube + 人工噪声 $\rightarrow$ 模拟 Brep 模型 $\rightarrow$ 把带噪声的点和网格拉回解析式
![[1971747224680_.pic.jpg]]
![[1981747224681_.pic.jpg]]
点云可行，但网格可能会出现自相交
几何优化依赖[[基于调和映射的二次曲面分块网格高质量重建方法]]
### 有机模型
由于主曲率特征也被用来分块，外加上曲面自由生长算法，我们的方法在有机模型上也具备普适性，可以利用二次曲面可解析的特性用来快速估算点到有机模型的距离和投影点,是比凸包分解更迅速的方式，目前大多数基于特征的分块算法难以分割G2连续拼接的曲面，而基于能量优化的算法多数依赖于需要拟合的patch的个数和初始分布，而我们的工作可以根据用户给定的期望误差无穷地逼近任意有机模型，我们的方法在部分有机模型上的表现如下所示